<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= site_title %>
  </title>
  <link rel="icon" href="<%= favicon %>">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0.31/dist/fancybox.css">
  <style>
    /*------------------------------
Reset
------------------------------*/
    html {
      -webkit-box-sizing: border-box;
      box-sizing: border-box;
      background-color: #f0f1f1;
      color: #343333;
    }

    *,
    *:before,
    *:after {
      -webkit-box-sizing: inherit;
      box-sizing: inherit;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    figure {
      margin: 0;
      padding: 0;
      display: block;
      position: relative;
    }

    img {
      max-width: 100%;
      height: auto;
    }

    /*------------------------------
Crazy Grid
------------------------------*/
    .crazy-grid {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding-top: 40px;
      /* 为了避免内容被固定的Tab遮挡 */
    }

    /* 组图同一竖排上下些许空隙 */
    .crazy-grid__box figure {
      margin-top: 10px;
    }

    .crazy-grid__box {
      float: left;
      width: 50%;
      padding: 60px;
    }

    .crazy-grid__box:nth-child(3n+1) {
      padding-top: 180px;
    }

    .crazy-grid__box:nth-child(3n+3) {
      padding-left: 120px;
    }

    .crazy-grid__box:nth-child(3n+4) {
      padding-right: 120px;
    }

    .crazy-grid__box:nth-child(4n+5) {
      padding-bottom: 120px;
    }

    @media (max-width: 1024px) {
      .crazy-grid__box {
        width: 100%;
        padding: 30px;
      }

      .crazy-grid__box:nth-child(3n+1) {
        padding-top: 30px;
      }

      .crazy-grid__box:nth-child(3n+3) {
        padding-left: 60px;
      }

      .crazy-grid__box:nth-child(3n+4) {
        padding-right: 60px;
      }

      .crazy-grid__box:nth-child(4n+5) {
        padding-bottom: 30px;
      }
    }

    @media (max-width: 767px) {
      .crazy-grid__box {
        width: 100%;
        padding: 15px !important;
      }

      .crazy-grid__box:nth-child(3n+1),
      .crazy-grid__box:nth-child(3n+3),
      .crazy-grid__box:nth-child(3n+4),
      .crazy-grid__box:nth-child(4n+5) {
        padding: 15px !important;
      }
    }

    .crazy-grid__box img {
      -webkit-box-shadow: 0 10px 20px 0px rgba(0, 0, 0, 0.5);
      box-shadow: 0 10px 20px 0px rgba(0, 0, 0, 0.5);
      transition: transform 360ms cubic-bezier(.2,.8,.2,1), box-shadow 360ms;
      will-change: transform;
    }

    /* 为所有图片添加 hover 缩放效果（在 figure hover 时触发） */
    .crazy-grid__box figure:hover img {
      transform: scale(1.04) translateY(-6px);
    }

    .crazy-grid__box .title {
      margin-top: 20px;
    }

    /*------------------------------
Bootstrap Custom
------------------------------*/
    .fixed-tabs {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background-color: (255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      transition: background 0.3s ease, backdrop-filter 0.3s ease, color 0.3s ease;
    }

    .fixed-tabs .nav-link {
      color: #b0b0b0
    }

    body {
      background-color: transparent !important;
    }

    /*------------------------------
Category Text
------------------------------*/
    .category-text {
      color: #888;
      font-size: 0.9em;
      margin-top: 0;
      padding: 0px 7dvw;
    }

    .category-text a {
      color: #000;
    }

    .category-text a:hover {
      color: #007bff;
    }

    /*------------------------------
Loading Blur-up
------------------------------*/
    .blur-up {
      -webkit-filter: blur(10px);
      filter: blur(10px);
      transition: filter 800ms, -webkit-filter 800ms;
    }

    .blur-up.lazyloaded {
      -webkit-filter: blur(0);
      filter: blur(0);
    }
    
    /*------------------------------
Lazy Load Placeholder
------------------------------*/
    .lazy-placeholder {
      opacity: 0;
      transition: opacity 300ms;
    }
    
    .lazy-placeholder.visible {
      opacity: 1;
    }
    
    /* Album hover & action styles */
    .album-box figure {
      position: relative;
      overflow: hidden;
      border-radius: 0; /* 不要对相册图片额外做圆角 */
      /* 把阴影放在 figure 上，这样不会被裁切，也与普通图片一致 */
      -webkit-box-shadow: 0 10px 20px 0px rgba(0, 0, 0, 0.5);
      box-shadow: 0 10px 20px 0px rgba(0, 0, 0, 0.5);
    }

    .album-box figure img {
      transition: transform 360ms cubic-bezier(.2,.8,.2,1), box-shadow 360ms;
      will-change: transform;
      display: block;
      position: relative;
      z-index: 0;
      /* 保持与其它图片一致的阴影 */
      -webkit-box-shadow: 0 10px 20px 0px rgba(0, 0, 0, 0.5);
      box-shadow: 0 10px 20px 0px rgba(0, 0, 0, 0.5);
    }

    /* 黑色覆盖层，用于 hover 时加深风格 */
    .album-box figure::after {
      content: '';
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      background: rgba(0,0,0,0);
      transition: background 260ms ease;
      z-index: 1;
      pointer-events: none;
    }

    /* hover 居中显示的相册徽章（在黑色遮罩上方） */
    .album-box figure .album-hover-badge {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -40%);
      background: none; /* 不要边框/背景 */
      color: #fff;
      padding: 0 6px;
      border-radius: 0;
      opacity: 0;
      pointer-events: none;
      z-index: 3; /* 在遮罩之上 */
      transition: transform 220ms ease, opacity 220ms ease;
      font-size: 0.98rem;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }

    .album-box figure:hover .album-hover-badge {
      transform: translate(-50%, -50%);
      opacity: 1;
    }

    /* 相册图标放到描述文本前的小图标样式 */
    .album-count-text .album-icon {
      width: 16px;
      height: 16px;
      vertical-align: text-bottom;
      margin-right: 6px;
      stroke: currentColor;
      fill: none;
      opacity: 0.9;
    }

    /* 仅在图片（figure） hover 时触发效果，而不是整个 album-box 区域 */
    .album-box figure:hover img {
      transform: scale(1.04) translateY(-6px);
      /* 给图片放大时，阴影由 figure 的 box-shadow 变化体现 */
    }

    .album-box figure:hover::after {
      background: rgba(0,0,0,0.32);
    }

    .album-box figure figcaption {
      transition: opacity 260ms ease, transform 260ms ease;
      opacity: 0.95;
      transform: translateY(0);
      pointer-events: none;
      z-index: 2; /* 显示在覆盖层之上 */
      border-radius: 0; /* 不额外圆角 */
    }

    /* 描述后的相册信息样式（小字） */
    .album-count-text {
      font-size: 0.85rem;
      color: #666;
      vertical-align: middle;
    }

    /* Action button (arrow) */
    .album-action {
      background: transparent !important;
      border: none !important; /* 不要边框 */
      padding: 6px !important;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 0 !important;
      box-shadow: none !important;
      color: inherit;
    }

    .album-action .arrow {
      width: 20px;
      height: 20px;
      display: inline-block;
      transition: transform 260ms ease;
      transform-origin: center;
    }

    /* Rotate arrow when album is open */
    .album-box[data-album-open="true"] .album-action .arrow {
      transform: rotate(180deg);
    }
  </style>
</head>

<body>
  <div class="fixed-tabs">
    <div class="container-fluid">
      <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
        <% categories.forEach(function(category, index) { %>
          <li class="nav-item">
            <a class="nav-link <%= index === 0 ? 'active' : '' %>" id="<%= category.id %>-tab" data-bs-toggle="tab"
              href="#<%= category.id %>" role="tab" aria-controls="<%= category.id %>"
              aria-selected="<%= index === 0 ? 'true' : 'false' %>">
              <%= category.name %>
            </a>
          </li>
          <% }); %>
      </ul>
    </div>
  </div>

  <!-- !MAIN START -->
  <div class="container-fluid mt-5">
    <div class="tab-content" id="myTabContent">
      <% categories.forEach(function(category, index) { %>
        <div class="tab-pane fade <%= index === 0 ? 'show active' : '' %>" id="<%= category.id %>" role="tabpanel"
          aria-labelledby="<%= category.id %>-tab">
          <div class="crazy-grid">
            <div class="crazy-grid__box category-text">
              <p>
                <%- category.description %>
              </p>
            </div>
            <% category.images.forEach(function(image, imgIndex) { %>
              <% if (image && image.type === 'album') { %>
                <% var cover = (image.images && image.images.length) ? image.images[0].url : (image.url || ''); %>
                <div class="crazy-grid__box lazy-placeholder album-box <%= imgIndex < 6 ? 'visible' : '' %>" <% if (imgIndex >= 6) { %>style="display:none;"<% } %> data-category="<%= category.id %>" data-index="<%= imgIndex %>" data-album-index="<%= imgIndex %>" data-album-images='<%- JSON.stringify(image.images || []) %>' data-album-open="false">
                  <% if (imgIndex < 6) { %>
                  <a href="<%= cover %>" class="album-toggle" data-fancybox="<%= category.id %>_box">
                    <figure>
                        <img data-src="<%= cover %>" class="lazyload img-fluid blur-up">
                        <div class="album-hover-badge">组图 · <span class="album-count"><%= (image.images || []).length %></span> 张</div>
                    </figure>
                  </a>
                  <div class="title">
                    <span class="desc">
                      <%- image.description %>
                    </span>
                    <small class="album-count-text ms-2 text-muted">
                      <svg class="album-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M3 7h14v12H3z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M7 3h14v12H7z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      组图 · <%= (image.images || []).length %> 张
                    </small>
                    <button type="button" class="ms-2 album-action" style="vertical-align:middle;" aria-pressed="false" aria-label="展开/收起相册">
                      <svg class="arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </button>
                  </div>
                  <% } else { %>
                  <a href="<%= cover %>" class="album-toggle" data-fancybox="<%= category.id %>_box" style="display:none;">
                    <figure>
                        <img data-src="<%= cover %>" class="lazyload img-fluid blur-up">
                        <div class="album-hover-badge">组图 · <span class="album-count"><%= (image.images || []).length %></span> 张</div>
                      </figure>
                  </a>
                  <div class="title" style="display:none;">
                    <span class="desc">
                      <%- image.description %>
                    </span>
                    <small class="album-count-text ms-2 text-muted" style="display:none;">
                      <svg class="album-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M3 7h14v12H3z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M7 3h14v12H7z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      组图 · <%= (image.images || []).length %> 张
                    </small>
                    <button type="button" class="ms-2 album-action" style="vertical-align:middle;display:none;" aria-pressed="false" aria-label="展开/收起相册">
                      <svg class="arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </button>
                  </div>
                  <% } %>
                </div>
              <% } else { %>
                <div class="crazy-grid__box lazy-placeholder <%= imgIndex < 6 ? 'visible' : '' %>" <% if (imgIndex >= 6) { %>style="display:none;"<% } %> data-category="<%= category.id %>" data-index="<%= imgIndex %>">
                  <% if (imgIndex < 6) { %>
                  <a href="<%= image.url %>" data-fancybox="<%= category.id %>_box">
                    <figure>
                      <img data-src="<%= image.url %>" class="lazyload img-fluid blur-up">
                    </figure>
                  </a>
                  <div class="title">
                    <span class="desc">
                      <%- image.description %>
                    </span>
                  </div>
                  <% } else { %>
                  <a href="<%= image.url %>" data-fancybox="<%= category.id %>_box" style="display:none;">
                    <figure>
                      <img data-src="<%= image.url %>" class="lazyload img-fluid blur-up">
                    </figure>
                  </a>
                  <div class="title" style="display:none;">
                    <span class="desc">
                      <%- image.description %>
                    </span>
                  </div>
                  <% } %>
                </div>
              <% } %>
            <% }); %>
          </div>
          <!-- sentinel: 用于 IntersectionObserver 分批触发加载 -->
          <div class="load-sentinel" data-category="<%= category.id %>" aria-hidden="true"></div>
        </div>
        <% }); %>
    </div>
  </div>
  <!-- !MAIN END-->

  <script src="https://gcore.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script src='https://gcore.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js'></script>
  <script src="https://gcore.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>
  <script src="https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0.31/dist/fancybox.umd.js"></script>
  <script>
    // 监听DOM加载完成事件
    document.addEventListener('DOMContentLoaded', function () {
      
      // 记录每个分类已经加载的图片数量
      var loadedImagesCount = {};
      
      // 初始化 Fancybox
      Fancybox.bind("[data-fancybox]", {
        Toolbar: false,
        smallBtn: true,
        buttons: [],
        Thumbs: false,
      });

      document.querySelectorAll('.tab-pane').forEach(function (pane) {
        var grid = pane.querySelector('.crazy-grid');
        var categoryId = pane.id;

  // 每个分类的已加载图片计数将在 sentinel 初始化时计算（基于模板中 visible 类）

        // 初始化Masonry
        var msnry = new Masonry(grid, {
          itemSelector: '.crazy-grid__box',
          percentPosition: true
        });

        // 慢网场景优化，超过一定时间后触发一次layout
        var timeoutDOM = setTimeout(function () {
          msnry.layout();
        }, 5000);

        // 监听懒加载图片加载完成事件
        grid.addEventListener('lazyloaded', function () {
          clearTimeout(timeoutDOM); // 清除定时器
          msnry.layout();
        });
        
        // 相册展开/收起处理：点击相册时动态插入/移除该相册的图片
        function toggleAlbum(albumBox) {
          if (!albumBox) return;
          if (albumBox.getAttribute('data-album-open') === 'true') {
            collapseAlbum(albumBox);
          } else {
            expandAlbum(albumBox);
          }
        }

        function expandAlbum(albumBox) {
          var raw = albumBox.getAttribute('data-album-images') || '[]';
          var images = [];
          try { images = JSON.parse(raw); } catch (e) { images = []; }
          if (!images.length) return;

          var albumIndex = albumBox.getAttribute('data-album-index');
          var inserted = [];

          // 使用 DocumentFragment 按原始顺序一次性插入，避免反序
          var frag = document.createDocumentFragment();
          images.forEach(function (img, idx) {
            var box = document.createElement('div');
            box.className = 'crazy-grid__box lazy-placeholder visible inserted-from-album';
            box.setAttribute('data-category', categoryId);
            box.setAttribute('data-inserted-from', albumIndex);

            var a = document.createElement('a');
            a.href = img.url;
            a.setAttribute('data-fancybox', categoryId + '_box');

            var figure = document.createElement('figure');
            var im = document.createElement('img');
            im.setAttribute('data-src', img.url);
            im.className = 'lazyload img-fluid blur-up';
            figure.appendChild(im);
            a.appendChild(figure);

            var title = document.createElement('div');
            title.className = 'title';
            var span = document.createElement('span');
            span.className = 'desc';
            span.innerHTML = img.description || '';
            title.appendChild(span);

            box.appendChild(a);
            box.appendChild(title);

            frag.appendChild(box);
            inserted.push(box);
          });

          // 在相册元素之后一次性插入所有图片
          albumBox.parentNode.insertBefore(frag, albumBox.nextSibling);

          // 让 Masonry 接管新元素，然后触发重布局
          msnry.appended(inserted);
          // reloadItems + layout 更保险，以确保内部索引更新
          msnry.reloadItems();
          msnry.layout();

          // 重新绑定 Fancybox（安全的重复绑定）
          Fancybox.bind('[data-fancybox]', {
            Toolbar: false,
            smallBtn: true,
            buttons: [],
            Thumbs: false,
          });

          // 去抖的 layout 调用（在图片 load 时触发，避免多次 layout）
          var relayoutTimer = null;
          function scheduleRelayout() {
            if (relayoutTimer) clearTimeout(relayoutTimer);
            relayoutTimer = setTimeout(function() {
              try { msnry.reloadItems(); } catch (e) {}
              try { msnry.layout(); } catch (e) {}
            }, 80);
          }

          if (window.lazySizes) {
            // 确保新增图片带有 lazyload 类（已设置），并在真实图片 load 时触发布局
            inserted.forEach(function(el) {
              var imgs = el.querySelectorAll('img');
              imgs.forEach(function(img) {
                // 绑定 load 以防占位图替换后位置变化
                img.addEventListener('load', scheduleRelayout);
                // 如果 image 已经缓存并完成加载，手动触发一次
                if (img.complete) scheduleRelayout();
              });
            });
          } else {
            // 未加载 lazySizes 时也确保布局在短延迟后生效
            setTimeout(function() { msnry.reloadItems(); msnry.layout(); }, 120);
          }

          albumBox.setAttribute('data-album-open', 'true');
          var btn = albumBox.querySelector('.album-action'); if (btn) btn.setAttribute('aria-pressed', 'true');
        }

        function collapseAlbum(albumBox) {
          var albumIndex = albumBox.getAttribute('data-album-index');
          var selector = '.inserted-from-album[data-inserted-from="' + albumIndex + '"]';
          var inserted = Array.prototype.slice.call(grid.querySelectorAll(selector));
          if (!inserted.length) {
            albumBox.setAttribute('data-album-open', 'false');
            var btn = albumBox.querySelector('.album-action'); if (btn) btn.textContent = '展开';
            return;
          }

          // 先从 Masonry 中移除，再从 DOM 删除
          try { msnry.remove(inserted); } catch (e) {}
          inserted.forEach(function (el) { el.parentNode && el.parentNode.removeChild(el); });
          // reloadItems + layout to ensure indices update
          try { msnry.reloadItems(); } catch (e) {}
          try { msnry.layout(); } catch (e) {}

          albumBox.setAttribute('data-album-open', 'false');
          var btn = albumBox.querySelector('.album-action'); if (btn) btn.setAttribute('aria-pressed', 'false');
        }

        // 绑定相册按钮
        grid.querySelectorAll('.album-box').forEach(function (albumBox) {
          var btn = albumBox.querySelector('.album-action');
          if (btn) btn.addEventListener('click', function (e) {
            e.preventDefault();
            toggleAlbum(albumBox);
          });
          var toggleLink = albumBox.querySelector('.album-toggle');
          if (toggleLink) toggleLink.addEventListener('click', function (e) {
            // 阻止直接打开 Fancybox，改为展开相册（如果希望同时可直接打开封面则可改）
            e.preventDefault();
            toggleAlbum(albumBox);
          });
        });
        
        // 使用 IntersectionObserver 在网格底部的 sentinel 可见时分批加载（更准确，避免大片空白）
        (function setupSentinelAndObserver() {
          var sentinel = pane.querySelector('.load-sentinel[data-category="' + categoryId + '"]');
          var placeholders = grid.querySelectorAll('.lazy-placeholder');

          // 计算初始已加载数量（模板中默认前 N 项可见）
          var initialLoaded = 0;
          placeholders.forEach(function(p) { if (p.classList.contains('visible')) initialLoaded++; });
          loadedImagesCount[categoryId] = Math.min(initialLoaded || 0, placeholders.length);

          var batchSize = 12; // 每次加载的批次大小，可按需调整

          // 创建 observer
          var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                loadMoreImages(categoryId, msnry, observer, entry.target, batchSize);
              }
            });
          }, { root: null, rootMargin: '600px 0px', threshold: 0.01 });

          // 如果还有未加载的占位，则观察 sentinel；否则隐藏 sentinel
          if (loadedImagesCount[categoryId] < placeholders.length) {
            try { observer.observe(sentinel); } catch (e) { /* ignore */ }
          } else if (sentinel) {
            sentinel.style.display = 'none';
          }
        })();

        // 监听切换Tab事件
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function (tab) {
          tab.addEventListener('shown.bs.tab', function (e) {
            var target = document.querySelector(e.target.getAttribute("href"));
            var grid = target.querySelector('.crazy-grid');
            var categoryId = target.id;

            //触发Masonry布局
            msnry.layout();

            // 慢网场景优化，超过一定时间后触发一次layout
            var timeoutTabSwitch = setTimeout(function () {
              msnry.layout();
            }, 5000);

            // 监听懒加载图片加载完成事件
            grid.addEventListener('lazyloaded', function () {
              clearTimeout(timeoutTabSwitch); // 清除定时器
              msnry.layout();
            });

            // 更新URL中的hash
            history.replaceState(null, null, e.target.getAttribute("href"));
            
            // 切换 Tab 时触发 Masonry 布局并刷新（不再使用全局 scroll 绑定）
          });
        });

        // 检查URL中的锚点并激活相应的Tab
        var hash = window.location.hash;
        if (hash) {
          var tab = document.querySelector('a[href="' + hash + '"]');
          if (tab) {
            var tabInstance = new bootstrap.Tab(tab);
            tabInstance.show();
          }
        }
      });
      
      // 加载更多图片的函数（按批次加载）
      // 参数: categoryId, msnry, observer(optional), sentinel(optional), batchSize(optional)
      function loadMoreImages(categoryId, msnry, observer, sentinel, batchSize) {
        batchSize = batchSize || 12;
        var placeholders = document.querySelectorAll('.lazy-placeholder[data-category="' + categoryId + '"]');
        var startIndex = loadedImagesCount[categoryId] || 0;
        var endIndex = Math.min(startIndex + batchSize, placeholders.length);

        var hasNewImages = false;

        for (var i = startIndex; i < endIndex; i++) {
          var placeholder = placeholders[i];
          if (placeholder) {
            // 如果外层被设置为 display:none（服务端模板会在初始不可见项设置），先恢复外层显示
            if (placeholder.style && placeholder.style.display === 'none') {
              placeholder.style.display = '';
            }
            placeholder.classList.add('visible');

            // 显示隐藏的图片和描述（原模板将内部元素设为 display:none）
            var hiddenElements = placeholder.querySelectorAll('[style*="display:none"], [style*="display: none"]');
            for (var j = 0; j < hiddenElements.length; j++) {
              hiddenElements[j].style.display = '';
            }

            hasNewImages = true;
          }
        }

        if (hasNewImages) {
          loadedImagesCount[categoryId] = endIndex;

          // 触发新图片的懒加载并重新布局
          setTimeout(function() {
            try { msnry.reloadItems(); } catch (e) {}
            try { msnry.layout(); } catch (e) {}
          }, 80);
        }

        // 如果已加载完全部，占位节点不再需要观察并隐藏 sentinel
        if (loadedImagesCount[categoryId] >= placeholders.length) {
          if (observer && sentinel) {
            try { observer.unobserve(sentinel); } catch (e) {}
          } else if (sentinel) {
            sentinel.style.display = 'none';
          }
        }
      }
    });
  </script>
</body>

</html>